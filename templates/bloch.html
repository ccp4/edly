<!DOCTYPE html>
 <html lang="en" ng-app="app">

 <head>
     <meta charset="utf-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <meta name="description" content="Electron diffraction online simulators">
     <meta name="author" content="tarik drevon">
     <title> Electron diffraction Dashboard </title>
     <link rel="shortcut icon" href="static/favicon.ico" >
     <link rel="stylesheet" href="static/bower_components/bootstrap-css/css/bootstrap.min.css">
     <link href="/static/css/all_gg.css" rel="stylesheet">
     <link href="/static/css/bw_app.css" rel="stylesheet">
     <link href="/static/css/popup.css" rel="stylesheet">
     <link href="/static/css/dropdown.css" rel="stylesheet">
     <!-- <link rel="stylesheet" href="static/bower_components/jquery-ui/themes/base/jquery-ui.css"> -->
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
     <script src="static/bower_components/angular/angular.min.js"></script>
     <script src="static/bower_components/angular-aria/angular-aria.js"></script>
     <script src="static/bower_components/angular-touch/angular-touch.js"></script>
     <script src="static/bower_components/plotly-latest.min.js"></script>
     <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
         tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
       });
     </script>
     <script type="text/javascript" async
      src="static/bower_components/MathJax/MathJax.js?config=TeX-MML-AM_CHTML">
     </script>

     <script src="static/js/app.js"></script>
     <script src="static/jmol/jsmol/JSmol.min.js"></script>
     <script src="static/jmol/jsmol/js/Jmol2.js"></script>
     <script > jmolInitialize("/static/jmol/jsmol");</script>
 </head>


 <body>


  <div class="container-fluid mt-3" style="margin:0px;padding-left:0px;background-color:#3c4a66;">
    <div ng-controller="viewer" class="row" style="margin:0px;padding-left:0px">
      <div class="header">
         <div style="font-size:30px;text-align:center;padding-top: 10px;"> Electron diffraction dashboard </div>
         <!-- Menu -->
         <div class="menu">
           <div class="dropdown">
            <button class="dropbtn">Structures</button>
            <div class="dropdown-content">
              <a href="" onclick="dialog_new_structure()">New</a>
              <a href="" ng-repeat="x in structures" ng-click="set_structure(x)">{a x a}</a>
            </div>
           </div>
           <div class="dropdown">
            <button class="dropbtn">Links</button>
            <div class="dropdown-content">
              <a href="" onclick="open_link('https://www.ccp4.ac.uk/ccp4-ed/projects/dynamical_diffraction/')">Theory</a>
              <a href="" onclick="open_link('https://debloch.readthedocs.io/en/latest/reference/debloch.bloch.Bloch.html')">Documentation</a>
              <a href="" onclick="open_link('http://ccp4serv6.rc-harwell.ac.uk:8010/blochwave/report/report.html')">Tests</a>
            </div>
           </div>
           <div class="dropdown">
            <button class="dropbtn">How to</button>
            <div class="dropdown-content">
              <a href="" ng-repeat="(tle,gif) in gifs" ng-bind="tle" ng-mouseenter="showIt(tle)" ng-mouseleave="hideIt(tle)">
              </a>
            </div>
           </div>
         </div><!-- menu -->
         <div ng-repeat="(tle,gif) in gifs" ng-show="popup[tle]" class="gif"/>
           <a href="{a gif a}"> <img ng-src="{a gif a}"  /></a>
        </div>
      </div>

      <!-- Panel -->
      <div class="col-sm-2" style="padding-left:5px;padding-right:0px;">
        <div class="panel" style="background-color:#b5ccda">

          <!-- Structure -->
          <div class="panel">
            <div class="">
              <a class="btn btn-primary myBtn popup jmol" ng-click="toggle_mode('molecule')" ng-mouseenter="showIt('mol')" ng-mouseleave="hideIt('mol')">
                <img ng-hide="modes['molecule']" src="/static/images/jsmol.png"/>
                <img ng-show="modes['molecule']" src="/static/images/edly.png"/>
                <span class="popuptext" ng-show="popup['mol']"> show/hide molecule </span>
              </a>
            </div>
            <div style="font-size:25px">  {a structure a} </div>
            <div class="theta_phi">
              <a class="popup" ng-click="expand['struct']=!expand['struct']" ng-mouseenter="showIt('expand_struct')" ng-mouseleave="hideIt('expand_struct')" style="float:right;bottom:5px">
                <span ng-class="{'glyphicon glyphicon-chevron-down':!expand['struct'],'glyphicon glyphicon-chevron-up':expand['struct']}">
                  <span class="popuptext" style="" ng-show="popup['expand_struct']" ng-bind="expand_str[expand['struct']]"></span>
                </span>
              </a>
              <div style="text-align: left;margin-left:10px;">
                <span style="font-size:18px;text-align:center" ng-bind="crys['file']"> </span>
                <span style="display:none" ng-bind="cif_file"> </span>
              </div>
              <div ng-show="expand['struct']" >
                <div style="font-size:16px;margin:5px;">Lattice parameters : </div>
                <div style="margin-left:10px;">
                  <span>  a=<span ng-bind="crys['a']"/> </span>
                  <span>, b=<span ng-bind="crys['b']"/> </span>
                  <span>, c=<span ng-bind="crys['c']"/> </span>
                </div>
                <div style="margin-left:10px;">
                  <!-- <span>  \(alpha\)=<span ng-bind="crys['alpha']"/></span> -->
                  <span>  $\alpha$=<span ng-bind="crys['alpha']"/></span>
                  <span>, $\beta$ =<span ng-bind="crys['beta']" /></span>
                  <span>, $\gamma$=<span ng-bind="crys['gamma']"/></span>
                </div>
                <div style="font-size:16px;margin:5px;">Lattice vectors : </div>
                <div style="margin-left:10px;">
                  <div> $a_1$=<span ng-bind="crys['a1']"/></div>
                  <div> $a_2$=<span ng-bind="crys['a2']"/></div>
                  <div> $a_3$=<span ng-bind="crys['a3']"/></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Frames panel -->
          <div class="panel" ng-show="!modes['molecule'] && max_frame>0">
            <div class="row">
              <div class="col-sm-8">
                <h4>Exp Frames : </h4>
              </div>
            </div>
            No:
            <input type="number" min="1" max="max_frame" ng-model="frame" ng-key-enter="update_frame()" style="width: 80px" />
            <span> / <span ng-bind="max_frame"/></span>
            <a class="btn-sm btn-primary"  ng-click="dec_frame()">
              <span class="glyphicon glyphicon-step-backward"></span >
            </a>
            <a class="btn-sm btn-primary"  ng-click="inc_frame()">
              <span class="glyphicon glyphicon-step-forward"></span >
            </a>
          </div>

          <div class="" ng-hide="modes['molecule']" style="margin: 0px;margin-left: 9px;margin-bottom:-5px;">
            <a class="btn btn-primary popup tab_btn" ng-style="mode_style['frames']" ng-click="set_analysis_mode('frames')" ng-mouseenter="showIt('frames')" ng-mouseleave="hideIt('frames')">
              <span class="gg-stack"></span >
              <span class="popuptext" ng-show="popup['frames']"> Frames mode </span>
            </a>
            <a class="btn btn-primary popup tab_btn" ng-style="mode_style['bloch']" ng-click="set_analysis_mode('bloch')" ng-mouseenter="showIt('bloch_solver')" ng-mouseleave="hideIt('bloch_solver')">
              <span class="gg-edit-unmask"></span >
              <span class="popuptext" ng-show="popup['bloch_solver']"> Bloch solver </span>
            </a>
            <a class="btn btn-primary popup tab_btn" ng-style="mode_style['ms']" ng-click="set_analysis_mode('ms')" ng-mouseenter="showIt('ms_solver')" ng-mouseleave="hideIt('ms_solver')">
              <span class="gg-format-justify" style="margin-top:0"></span >
              <span class="popuptext" ng-show="popup['ms_solver']"> Multislice solver </span>
            </a>
          </div>


          <!--  ///////////////////////// -->
          <!-- Exp panel -->
          <!--  ///////////////////////// -->
          <div class="panel bloch_panel"  ng-show="modes['analysis']=='frames' && !modes['molecule']">
            <a class="btn btn-primary myBtn popup" ng-click="upload('exp')" ng-mouseenter="showIt('exp')" ng-mouseleave="hideIt('exp')">
              <img src="/static/images/exp_button.png" />
              <span class="popuptext" ng-show="popup['exp']"> Upload experimental dataset </span>
            </a>
            <a class="btn btn-primary myBtn popup" ng-click="upload('sim')" ng-mouseenter="showIt('sim')" ng-mouseleave="hideIt('sim')">
              <img src="/static/images/bloch_button.png" />
              <span class="popuptext" ng-show="popup['sim']"> Upload simulated dataset </span>
            </a>
            <a class="btn btn-primary myBtn popup" ng-click="upload('pets')" ng-mouseenter="showIt('pets')" ng-mouseleave="hideIt('pets')">
              <img src="/static/images/proc_button.png" />
              <span class="popuptext" ng-show="popup['pets']"> Import processed data from pets/dials </span>
            </a>
          </div>

          <!--  ///////////////////////// -->
          <!-- Multislice solver -->
          <!--  ///////////////////////// -->
          <div class="panel bloch_panel" ng-show="modes['analysis']=='ms' && !modes['molecule']" >
            <div class="row">
              <div class="col-sm-11 bloch_solver" >
                Multislice
              </div>
            </div>
          </div>

          <!--  ///////////////////////// -->
          <!-- Bloch solver -->
          <!--  ///////////////////////// -->
          <div class="panel bloch_panel" ng-show="modes['analysis']=='bloch' && !modes['molecule']" >
            <div class="row">
              <div class="col-sm-11 bloch_solver" >
                Bloch solver
              </div>
            </div>

            <!-- ////////////////////////////////////////////
            Parameters Panel
            //////////////////////////////////////////// -->
            <!-- Simulation Parameters  -->
            <div class="row" >
              <div class="theta_phi" >
                <a class="popup" ng-click="expand['sim']=!expand['sim']" ng-mouseenter="showIt('expand_sim')" ng-mouseleave="hideIt('expand_sim')" style="float:right;bottom:5px">
                  <span ng-class="{'glyphicon glyphicon-chevron-down':!expand['sim'],'glyphicon glyphicon-chevron-up':expand['sim']}">
                    <span class="popuptext" style="" ng-show="popup['expand_sim']" ng-bind="expand_str[expand['sim']]"></span>
                  </span>
                </a>
                <div style="font-size:14px;margin-bottom:5px;">Simulation parameters :</div>
                <table style="margin-left: 10px;" ng-show="expand['sim']">
                  <!-- keV -->
                  <tr>
                    <td class="td-in">
                      <span>keV</span>
                      <span class="popup glyphicon glyphicon-question-sign bloch_info" ng-mouseenter="popup['keV']=true" ng-mouseleave="popup['keV']=false" >
                        <span class="popuptext" ng-show="popup['keV']"> beam energy </span>
                      </span>
                    </td>
                    <td class="td-in popup">
                      <input ng-show="show_keV" type="number" min="1" max="1000" ng-model="bloch['keV']" class="bloch_input" ng-key-enter="update_bloch()" >
                      <span  ng-hide="show_keV" ng-bind="bloch['keV']" ng-dblclick="show_keV=true"></span>
                    </td>
                    <td class="td-in" ng-show="show_keV">
                      <a class="btn-sm btn-primary popup" ng-click="show_keV=false" ng-mouseenter="showIt('lock_keV')" ng-mouseleave="hideIt('lock_keV')" style="margin-left: 7px;">
                        <span class="glyphicon glyphicon-lock" />
                        <span class="popuptext" style="" ng-show="popup['lock_keV']">
                          Lock keV parameter to experiment </span>
                      </a>
                    </td>
                  </tr>
                  <!-- Nmax -->
                  <tr>
                    <td class="td-in">
                      <span>Nmax</span>
                      <span class="popup glyphicon glyphicon-question-sign bloch_info" ng-mouseenter="popup['Nmax']=true" ng-mouseleave="popup['Nmax']=false" >
                        <span class="popuptext" ng-show="popup['Nmax']"> Maximum resolution : reflection index would be (Nmax,Nmax,Nmax) </span>
                      </span>
                    </td>
                    <td class="td-in">
                      <input type="number" min="0" ng-model="bloch['Nmax']" class="bloch_input" ng-key-enter="update_bloch()" ng-change="bloch_solve_reset()">
                    </td>
                  </tr>
                  <!-- Smax -->
                  <tr>
                    <td class="td-in">
                      <span> Smax </span>
                      <span class="popup glyphicon glyphicon-question-sign bloch_info" ng-mouseenter="popup['Smax']=true" ng-mouseleave="popup['Smax']=false" >
                        <span class="popuptext" ng-show="popup['Smax']"> Maximum excitation error </span>
                      </span>
                    </td>
                    <td class="td-in">
                      <input type="number" min="0.000001" max="1" ng-model="bloch['Smax']" class="bloch_input" ng-key-enter="update_bloch()" ng-change="bloch_solve_reset()">
                    </td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- Orientation u -->
            <div class="row">
              <div class="theta_phi">
                <a class="popup" ng-click="expand['u']=!expand['u']" ng-mouseenter="showIt('expand_u')" ng-mouseleave="hideIt('expand_u')" style="float:right;bottom:5px">
                  <span ng-class="{'glyphicon glyphicon-chevron-down':!expand['u'],'glyphicon glyphicon-chevron-up':expand['u']}">
                    <span class="popuptext" style="" ng-show="popup['expand_u']" ng-bind="expand_str[expand['u']]"></span>
                  </span>
                </a>
                <div style="font-size:14px;margin-bottom:5px;">Beam orientation :</div>
                <div ng-show="expand['u']">

                  <!-- buttons -->
                  <div class="row" style="margin-bottom: 10px">
                    <span ng-show="dat['pets']">
                      <a class="btn-sm btn-primary popup" ng-click="toggle_manual_mode()" ng-mouseenter="showIt('manual')" ng-mouseleave="hideIt('manual')" style="margin-left: 7px;">
                        <span ng-class="{'glyphicon glyphicon-wrench':!modes['manual'],'glyphicon glyphicon-lock':modes['manual']}" />
                        <span class="popuptext" style="" ng-show="popup['manual']">
                          <div ng-show="modes['manual']"> Lock u to experimental frames  </div>
                          <div ng-hide="modes['manual']"> Set u manually   </div></span>
                      </a>
                    </span>
                    <span ng-show="modes['manual']" style="margin-left:5px;">
                      <a class="btn-sm btn-primary popup" ng-style="u_style['edit']" ng-click="set_u_mode('edit')" ng-mouseenter="showIt('u_edit')" ng-mouseleave="hideIt('u_edit')">
                        <span class="glyphicon glyphicon-pencil" />
                        <span class="popuptext" style="" ng-show="popup['u_edit']"> Edit u manually  </span>
                      </a>
                      <a class="btn-sm btn-primary popup" ng-style="u_style['move']" ng-click="set_u_mode('move')" ng-mouseenter="showIt('u_move')" ng-mouseleave="hideIt('u_move')">
                        <span class="glyphicon glyphicon-move" />
                        <span class="popuptext" style="" ng-show="popup['u_move']"> Change Euler angles of u using arrows  </span>
                      </a>
                      <a class="btn-sm btn-primary popup" ng-style="u_style['rock']" ng-click="set_u_mode('rock')" ng-mouseenter="showIt('u_rock')" ng-mouseleave="hideIt('u_rock')">
                        <span class="gg-icon gg-spectrum" ></span>
                        <span class="popuptext" style="" ng-show="popup['u_rock']"> Set rocking curve for u </span>
                      </a>
                    </span>
                    <a class="btn-sm btn-primary popup" ng-click="show_u()" ng-mouseenter="showIt('u_show')" ng-mouseleave="hideIt('u_show')" style="float:right;right:15px;" >
                      <span class="glyphicon glyphicon-eye-open" />
                      <span class="popuptext" style="" ng-show="popup['u_show']"> Show u orientation  </span>
                    </a>
                  </div>

                  <!-- frame mode or edit mode -->
                  <div class="bloch_param" ng-hide="modes['manual'] && modes['u']!='edit'">
                      <span> u </span>
                      <span class="popup glyphicon glyphicon-question-sign bloch_info" ng-mouseenter="popup['u_info']=true" ng-mouseleave="popup['u_info']=false">
                        <span class="popuptext" ng-show="popup['u_info']"> Beam orientation based on experimental frame </span>
                      </span>
                      <span> = </span>
                      <span  ng-show="!modes['manual']"                      ng-bind="bloch['u']" ></span>
                      <input ng-show="modes['manual'] && modes['u']=='edit'" ng-model="bloch['u']" ng-key-enter="update_bloch()" ng-change="bloch_solve_reset()" type="text" class="bloch_input" style="width:180px" >
                  </div>

                  <!-- move mode-->
                  <div ng-show="modes['manual'] && modes['u']=='move'" >
                    <span style="float:right;"class="popup glyphicon glyphicon-question-sign " ng-mouseenter="popup['rot_help']=true" ng-mouseleave="popup['rot_help']=false">
                      <div class="popuptext" style=";width:200px;text-align:left" ng-show="popup['rot_help']">
                        <div> click on the hand and press hotkeys :
                          <br> &nbsp left  : decrement phi
                          <br> &nbsp right : increment phi
                          <br> &nbsp down  : decrement theta
                          <br> &nbsp up    : increment theta
                          <br> &nbsp pagedown  : increase dt
                          <br> &nbsp pageup    : decrease dt
                          <br> &nbsp backspace : reset rate
                          <br> &nbsp Enter : solve intensities
                          <br> For theta,phi and dt :
                          <br> &nbsp double-click : set the input value manually
                          <br> &nbsp press Enter to validate
                        </div>
                      </div>
                    </span>
                    <div style="font-size:14px;margin-bottom:5px;">Orientation tweaking :
                      <a tabindex="1" ng-keydown="theta_phi_cb($event)" class="btn-sm btn-primary" style="margin-right:0px;margin-left:0px" ng-click="popup['move_thick']=false" >
                        <span class='glyphicon glyphicon-hand-down' />
                      </a>
                    </div>
                    <table style="margin-left: 20px;" >
                      <tr><td class="td-in"> u     </td><td> = </td><td class="td-in"> <span ng-bind="bloch['u']"></span></td></tr>
                      <tr><td class="td-in"> theta </td><td> = </td><td class="td-in"> <span ng-hide="input['theta']" ng-bind="theta_phi[0]" ng-dblclick="input['theta']=true">deg</span> <input class="long_input" ng-show="input['theta']" ng-model="theta_phi[0]" ng-key-enter="set_input('theta','move')"></td></tr>
                      <tr><td class="td-in"> phi   </td><td> = </td><td class="td-in"> <span ng-hide="input['phi']"   ng-bind="theta_phi[1]" ng-dblclick="input['phi']=true"  >deg</span> <input class="long_input" ng-show="input['phi']"   ng-model="theta_phi[1]" ng-key-enter="set_input('phi'  ,'move')"  ></td></tr>
                      <tr><td class="td-in"> dt    </td><td> = </td><td class="td-in"> <span ng-hide="input['dtp']"   ng-bind="dtheta_phi"   ng-dblclick="input['dtp']=true"  >deg</span> <input class="long_input" ng-show="input['dtp']"   ng-model="dtheta_phi"   ng-key-enter="set_input('dtp'  ,'move')"  ></td></tr>
                    </table>
                  </div>

                  <!-- rock mode -->
                  <div ng-show="modes['manual'] && modes['u']=='rock'" class="">
                    <span style="float:right;" class="popup glyphicon glyphicon-question-sign " ng-mouseenter="popup['rock_help']=true" ng-mouseleave="popup['rock_help']=false">
                      <div class="popuptext" style=";width:200px;text-align:left" ng-show="popup['rock_help']">
                        <div> Rocking curve settings  :
                          <br> &nbsp u0   : initial orientation
                          <br> &nbsp u1   : last orientation
                          <br> &nbsp npts : number of orientation vectors
                        </div>
                      </div>
                    </span>
                    <div style="font-size:14px;margin-bottom:5px;">Rocking curve settings : </div>
                    <table style="margin-left: 20px;">
                      <tr><td class="td-in"> u0   </td><td class="td-in"> = </td>
                        <td> <input class="long_input" ng-change="rock_reset()" ng-model="rock['e0']"  ></td>
                        <td class="td-in" ng-show="dat['pets']">
                          <a class="btn-sm btn-primary popup" ng-click="set_rock(0)" ng-mouseenter="showIt('rock_set_0')" ng-mouseleave="hideIt('rock_set_0')">
                            <span class="glyphicon glyphicon-pushpin"/>
                            <span class="popuptext" style="" ng-show="popup['rock_set_0']"> Assign u0 to current experimental frame </span>
                          </a>
                        </td>
                      </tr>
                      <tr><td class="td-in"> u1   </td><td class="td-in"> = </td>
                        <td> <input class="long_input"  ng-change="rock_reset()" ng-model="rock['e1']"  ></td>
                        <td class="td-in" ng-show="dat['pets']">
                          <a class="btn-sm btn-primary popup" ng-click="set_rock(1)" ng-mouseenter="showIt('rock_set_1')" ng-mouseleave="hideIt('rock_set_1')">
                            <span class="glyphicon glyphicon-pushpin"/>
                            <span class="popuptext" style="" ng-show="popup['rock_set_1']"> Assign u1 to current experimental frame </span>
                          </a>
                        </td>
                      </tr>
                      <tr><td class="td-in"> npts </td><td class="td-in"> = </td>
                        <td> <input class="bloch_input"  ng-change="rock_reset()" ng-model="rock['npts']" type="number" min="2" max="100"></td>
                        <td class="td-in" ng-show="dat['pets']">
                          <a class="btn-sm btn-primary popup" ng-click="set_rock(2)" ng-mouseenter="showIt('rock_set')" ng-mouseleave="hideIt('rock_set')">
                            <span class="gg-icon gg-path-back" />
                            <span class="popuptext" style="" ng-show="popup['rock_set']"> Assign u0,u1 from current experimental frame </span>
                          </a>
                        </td>
                      </tr>
                      <tr><td class="td-in"> nbs  </td><td class="td-in"> = </td><td> <span ng-bind="nrock_beams" ></span></td></tr>
                    </table>
                    <!-- rock solve button-->
                    <div class="btn-sm btn-primary rock_solve_param" ng-click="solve_rock()" ng-style="rock_style">
                      {a solve_rock_btn a}
                    </div>
                    <div ng-show="rock_state=='done'">
                      <a class="btn-sm btn-primary btn-rock" ng-click="set_rock_sim('i');">
                        <span class="glyphicon glyphicon-fast-backward"></span >
                      </a>
                      <a class="btn-sm btn-primary btn-rock" ng-click="set_rock_sim('-')">
                        <span class="glyphicon glyphicon-step-backward"></span >
                      </a>
                      <span style="margin-left:5px" >
                        <span  tabindex="1" class="btn-sm btn-primary" ng-keydown="update_rock_sim($event)" ng-hide="input['rock_sim']" ng-bind="sim_rock" ng-dblclick="input['rock_sim']=true" ></span>
                        <input ng-show="input['rock_sim']" ng-model="sim_rock" ng-key-enter="set_input('rock_sim','rock')" style="width:30px;">
                      </span>
                      <a class="btn-sm btn-primary btn-rock" ng-click="set_rock_sim('+')">
                        <span class="glyphicon glyphicon-step-forward"></span >
                      </a>
                      <a class="btn-sm btn-primary btn-rock" ng-click="set_rock_sim('f')">
                        <span class="glyphicon glyphicon-fast-forward"></span >
                      </a>
                      <!--  show rocking curve -->
                      <a class="btn btn-primary myBtn-sm popup" style="border-width:2px;margin-left:5px;"  ng-click="show_rock()" ng-mouseenter="popup['show_rock']=true" ng-mouseleave="popup['show_rock']=false">
                        <img style="width: 90%;" src="/static/images/beam_vs_thick.png"/>
                        <span class="popuptext" ng-show="popup['show_rock']"> Show rocking curve </span>
                      </a>
                      <a class="btn btn-primary myBtn-sm popup" style="border-width:2px;"  ng-click="all_rock_sim()" ng-mouseenter="popup['show_rock_int']=true" ng-mouseleave="popup['show_rock_int']=false">
                        all
                        <span class="popuptext" ng-show="popup['show_rock_int']"> Overlay rocking curve patterns </span>
                      </a>
                    </div><!-- done buttons -->
                  </div><!-- rock mode -->

                </div><!-- expand['u'] -->
              </div><!-- theta_phi -->
            </div><!-- u -->

            <!-- solve button -->
            <div class="row " ng-hide="modes['manual'] && modes['u']=='rock'">
              <table style="margin-left: 5px;"><tr>
                <td class="td-in" style="width: 50%;">
                  <div class="btn-sm btn-primary bloch_solve_param"  ng-click="update_bloch()" ng-style="bloch_solve_style" ng-bind="bloch_solve_btn"></div>
                </td>
                <td class="" ng-show="dat['pets']">
                  <a class="btn-sm btn-primary popup" ng-click="expand['omega']=!expand['omega']" ng-mouseenter="showIt('omega_show')" ng-mouseleave="hideIt('omega_show')">
                    <span class="glyphicon glyphicon-repeat" />
                    <span class="popuptext" style="" ng-show="popup['omega_show']"> set in-plane rotation angle omega  </span>
                  </a>
                </td>
                <td class="td-in" style="font-size:13px">
                  <span>nbs = </span>
                  <span ng-bind="nbeams"></span>
                  <span class="popup glyphicon glyphicon-question-sign bloch_info" ng-mouseenter="popup['nbms']=true" ng-mouseleave="popup['nbms']=false" >
                    <span class="popuptext" ng-show="popup['nbms']"> Number of beams (size of the bloch matrix) </span>
                  </span>
                  <!-- <span> = </span> -->
                </td>
              </tr></table>
            </div>

            <!-- omega -->
            <div class="row" ng-show="expand['omega']">
              <div class="bloch_param" >
                <span> omega </span>
                <span class="popup glyphicon glyphicon-question-sign bloch_info" ng-mouseenter="popup['omega']=true" ng-mouseleave="popup['omega']=false">
                  <span class="popuptext" ng-show="popup['omega']"> In-plane rotation angle for experimental data (change to align it with expected reflections)</span>
                </span>
                <span> = </span>
                <input type="number" min="0" max="360" ng-model="omega" class="bloch_input"  ng-keypress="update_omega($event)">
              </div>
            </div>

            <!-- thickness dependence-->
            <div class="row" >
              <div class="theta_phi">
                <a class="popup" ng-click="expand['thick']=!expand['thick']" ng-mouseenter="showIt('expand_thick')" ng-mouseleave="hideIt('expand_thick')" style="float:right;bottom:5px">
                  <span ng-class="{'glyphicon glyphicon-chevron-down':!expand['thick'],'glyphicon glyphicon-chevron-up':expand['thick']}">
                    <span class="popuptext" style="" ng-show="popup['expand_thick']" ng-bind="expand_str[expand['thick']]"></span>
                  </span>
                </a>
                <div style="font-size:14px;margin-bottom:5px;">Thickness parameters :</div>
                <table style="margin-left: 10px;" ng-show="expand['thick']">
                  <tr>
                    <td class="td-in popup" ng-mouseenter="popup['thick']=true" ng-mouseleave="popup['thick']=false">
                      Thickness
                      <span class="popuptext" ng-show="popup['thick']"> sample thickness (Angstrom)</span>
                    </td>
                    <td class="td-in">
                      <input ng-keypress="update_thickness($event)" type="number" min="0" ng-model="bloch['thick']" class="mid_input"></td>
                    <td>
                      <a tabindex="1" ng-keydown="update_thickness($event)" class="btn-sm btn-primary" style="margin-right:0px;margin-left:0px" ng-click="popup['move_thick']=false" >
                        <span class='glyphicon glyphicon-hand-down' />
                      </a>
                      <span class="popup glyphicon glyphicon-question-sign" ng-mouseenter="popup['move_thick']=true" ng-mouseleave="popup['move_thick']=false" style="top:-10px;">
                        <span ng-show="popup['move_thick']" class="popuptext" style=";width:270px;text-align:left;font-size:14px" >
                          Click and use :
                          <br> &nbsp; arrows   : increase/decrease thickness
                          <br> &nbsp; pageup   : decrease dthick
                          <br> &nbsp; pagedown : increase dthick
                          <br> &nbsp; dthick : thickness increment
                          <br> &nbsp; dthick=<span ng-bind="dthick"></span>A
                        </span>
                    </td>
                  </tr>
                  <tr>
                    <td class="td-in popup" ng-mouseenter="popup['thicks']=true" ng-mouseleave="popup['thicks']=false">
                      Range
                      <span class="popuptext" ng-show="popup['thicks']"> Thickness range for beam vs thickness (t0,t1,nb_points) </span>
                    </td>
                    <td class="td-in">
                      <input ng-key-enter="beam_vs_thickness()" type="text" ng-model="bloch['thicks']"  class="mid_input">
                    </td>
                    <td>
                      <a class="btn btn-primary myBtn-sm" style="border-width:2px;" ng-click="beam_vs_thickness()">
                        <img style="width: 90%;" src="/static/images/beam_vs_thick.png"/>
                      </a>
                      <span class="popup glyphicon glyphicon-question-sign" ng-mouseenter="popup['beams_thick']=true" ng-mouseleave="popup['beams_thick']=false" style="top:-10px;">
                      <span class="popuptext" ng-show="popup['beams_thick']"> Show beam vs thickness </span>
                    </td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- miller indices table -->
            <div class="row">
              <div class="theta_phi">
                <a class="popup" ng-click="expand['refl']=!expand['refl']" ng-mouseenter="showIt('expand_refl')" ng-mouseleave="hideIt('expand_refl')" style="float:right;bottom:5px">
                  <span ng-class="{'glyphicon glyphicon-chevron-down':!expand['refl'],'glyphicon glyphicon-chevron-up':expand['refl']}" >
                    <span class="popuptext" style="" ng-show="popup['expand_refl']" ng-bind="expand_str[expand['refl']]"></span>
                  </span>
                </a>
                <div style="font-size:14px;margin-bottom:5px;">Selected reflections
                  <span class="popup glyphicon glyphicon-question-sign" ng-mouseenter="popup['sel_refl']=true" ng-mouseleave="popup['sel_refl']=false" >
                    <span ng-show="popup['sel_refl']" class="popuptext" style=";width:270px;text-align:left;font-size:14px" >
                      Reflections used for displaying :
                      <br> &nbsp;&nbsp;beam_vs_thickness
                      <br> &nbsp;&nbsp;rocking curves
                      <br> Click on diffraction pattern to select
                    </span>
                  </span>
                </div>
                <div id='table_miller' ng-show="expand['refl']">
                  <table  id="table_Miller_indices"  border="1" cellpadding="2">
                    <tr>
                        <th></th>
                        <th><b>miller_indices</b></th>
                    </tr>
                  </table>
                </div>
              </div>
            </div>

          </div><!-- Bloch solver -->
        </div><!-- Main Panel -->
      </div><!-- col-sm-2 -->



      <!-- molecule viewer -->
      <div class="col-sm-10" ng-show="modes['molecule']">
        <div class="panel">
          <div cif_file="cif_file" id="myJmol" ></div>
        </div>
      </div>


      <!-- Frame/analysis viewer -->
      <div class="col-sm-10" ng-hide="modes['molecule']" >
        <!-- Analysis figure -->
        <div class="panel" ng-show="modes['analysis']=='bloch'">
          <table>
            <tr>
              <td>
                <a class="btn-sm btn-primary popup" style="margin-right:3px" ng-click="toggle_mode('single')" ng-mouseenter="showIt('single_mode')" ng-mouseleave="hideIt('single_mode')">
                  <span ng-class="{'glyphicon glyphicon-duplicate':modes['single'],'glyphicon glyphicon-file':!modes['single']}" />
                  <span class="popuptext" style="" ng-show="popup['single_mode']"> toggle single/dual mode </span>
                </a>
                <span>max res : <input class="sm_input" type="number" min="0" ng-model="max_res" ng-key-enter="set_max_res()"></span>
              </td>
              <td ng-hide="modes['single']">
                <select ng-model="graph" ng-options="x.desc for x in graphs" ng-change="update_graph()"></select>
              </td>
            </tr>
            <!-- figs -->
            <tr>
              <td>
                <div id="plotly_div" style="width:100%;margin:5px;border-style:solid;float:left" >
                  <line-plot id=fig1 fig="fig1">
                </div>
              </td>
              <td ng-hide="modes['single']">
                <div style="width:100%;margin:5px;border-style:solid;float:right" >
                  <line-plot id=fig2 fig="fig2">
                </div>
              </td>
            </tr>
          </table>
        </div>


        <div class="panel" ng-show="modes['analysis']=='frames'" style="background-color: #80a6c7;">
          <div class="row"  >
            <!-- Simulated frame  -->
            <div class="col-sm-6" ng-if="dat['sim']==true">
              <h3> Simulated Frames </h3>
              <div class="row">
                <div style="text-align:center">Brightness:<input type="number" ng-model="zmax['sim']" ng-keypress=update_zmax($event,'sim') style="width: 70px"></div>
              </div>
              <div class="row">
                <div class="frame">
                  <a ng-href="{a img['sim'] a}">
                    <img ng-src="{a img['sim'] a}" />
                  </a>
                </div>
              </div>
            </div>
            <!-- Experimental frame  -->
            <div class="col-sm-6" ng-if="dat['exp']==true">
              <h3> Experimental Frames </h3>
              <div class="row" >
                <div style="text-align:center">Brightness:<input type="number" ng-model="zmax['exp']" ng-keypress=update_zmax($event,'exp') style="width: 70px"></div>
              </div>
              <div class="row">
                <div class="frame">
                  <a  ng-href="{a img['exp'] a}">
                    <img  ng-src="{a img['exp'] a}" />
                  </a>
                </div>
              </div>
            </div>
          </div><!-- panel-->
        </div><!-- col-sm-12 -->

      </div><!-- Frame/analysis viewer -->


    </div><!-- ng-controller -->

    <!-- footer  -->
    <footer class="footer">
       Copyright Â© 2021, CCP4
       <div>Author : Tarik Drevon<div>
    </footer>
  </div>

  <!-- form -->
  <div id="dialog" title="new project">
    <p>Create a new structure?</p>
    <!-- <span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span> -->
    <form>
      <fieldset>
        <label for="name">Name</label>
        <input type="text" name="name" id="name" value="new" class="text ui-widget-content ui-corner-all">
        <div> Please, provide a cif file from : </div>
        <label for="radio-1">builtins</label><input onclick="set_cif()"  type="radio" name="radio-1" id="radio_cif" >
        <label for="radio-2">pdb     </label><input onclick="set_cif()"  type="radio" name="radio-1" id="radio_pdb">
        <label for="radio-3">file    </label><input onclick="set_cif()" type="radio" name="radio-1" id="radio_file" checked=true>
        <div id="cif_cif">
          <label for="cif"> Name : </label>
          <select name="cif" id="cif">
            {% for s in builtins %}
            <option>{{s}}</option>
            {% endfor %}
          </select>
        </div>
        <div id="cif_pdb">
          <label for="">pdb id : </label>
          <input type="text" name="pdb" id="pdb" value="" class="text ui-widget-content ui-corner-all">
        </div>
        <div id="cif_file">
          <label for="file_cif"> file : </label>
          <input type = "file" class="glyphicon glyphicon-file" name = "file_cif" id="file_cif" onchange="upload_cif()"/>
        </div>

        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
      </fieldset>
    </form>
    <div id="cif_error" style="color:red;display:none"></div>
  </div>

<script>
var TABLE_MILLER=document.getElementById('table_Miller_indices')
function addRow_tagTable(miller_indices) {
    if (!extract_list_indices_from_table().includes(miller_indices)) {
      var row = TABLE_MILLER.insertRow(TABLE_MILLER.rows.length);
      row.insertCell(0).innerHTML= '<div class="btn btn-delete btn-primary" onclick="deleteRow(this)" > <span class="glyphicon glyphicon-remove" /></div>';
      console.log(miller_indices)
      row.insertCell(1).innerHTML= `<div onmouseover="highlight('${miller_indices}',true)" onmouseout="highlight('${miller_indices}',false)" style="padding:2px;margin:0">${miller_indices}</div>`;
  }
}
function extract_list_indices_from_table() {
  let listTags=[]
  let listrows= TABLE_MILLER.children[0].children
  for (let row of listrows) {
    // console.log(row.cells[1].children[0]);
    listTags.push(row.cells[1].children[0].innerHTML)
  }
  return listTags.slice(1,)
}

function deleteRow(obj) {
    var index = obj.parentNode.parentNode.rowIndex;
    TABLE_MILLER.deleteRow(index);
}

////// function hover row point table miller
function highlight(miller_indices,val){

  var found = false;
  var data  = document.getElementById('fig1').data[0].customdata;
  var idx = 0;
  while (!found && idx<data.length){
    found = data[idx][1]==miller_indices;
    idx++;
  }
  if (found){
    if (val){
      found=false;
      var c_nb=0;
      while (!found && c_nb<3){
        found=document.getElementById('fig1').data[c_nb].visible==true;
        c_nb++;
      }
      if (found){
        // console.log(idx);// data[idx][1], miller_indices)
        Plotly.Fx.hover('fig1',[
          { curveNumber:c_nb-1, pointNumber:idx-1 },
        ]);
      }
    }
    else{
      Plotly.Fx.unhover('fig1',[]);
    }
  }
}

</script>


<script>
var dialog, form;
$(document).ready(function () {

  dialog = $( "#dialog" ).dialog({
    autoOpen: false,
    height: 500,
    width: 400,
    modal: true,
    buttons: {
      "create ": new_structure,
      Cancel: function() {
        dialog.dialog( "close" );
      },
    },
    close: function() {
      form[ 0 ].reset();
      $('#cif_error').hide()
      // allFields.removeClass( "ui-state-error" );
    }
  });

  form = dialog.find( "form" ).on( "submit", function( event ) {
    event.preventDefault();
    new_structure();
  });

  function new_structure(){
  //   // e.preventDefault();
    var val='';
    if      ($('#radio_cif')[0].checked)  {val='cif'}
    else if ($('#radio_pdb')[0].checked)  {val='pdb'}
    else if ($('#radio_file')[0].checked) {val='file'}
    else{return};
    var formData = {
        'name':$('#name')[0].value,
        'cif':$('#cif')[0].value,
        'pdb':$('#pdb')[0].value,
        'file':$('#file_cif')[0].value.replace('C:\\fakepath\\',''),
        'val':val,
      };
    console.log(formData);
    $.ajax({
      type:'POST',
      url:'/new_structure',
      data:formData,
      success: function(data){
         console.log(data);
         if (data=='ok'){
           dialog.dialog( "close" );
           window.location='/'
         }
         else{
           show_error(data)
         }
      }
    });
  };

});

function show_error(data,err){
  var msg='',color='green';
  if (err){
    msg='error : ';
    color='red'
  }
  $('#cif_error')[0].innerHTML=msg+data;
  $('#cif_error')[0].style.color=color;
  $('#cif_error').show()
}
// $(':file_cif').on('change', function () {
function upload_cif(){
  var files = $('#file_cif')[0].files;
  if (files.length>0) {
    var file = files[0];
    extension = file.name.split('.').pop();
    console.log(extension);
    if (extension !='cif'){
      show_error('upload a cif file thank you',true);return
    }
    else{
      // console.log(file.size);
      if (file.size > 1000*1024) {
        show_error('max upload size is 1Mo',true);return
      }
      else{
        console.log(file);
        $.ajax({
         url: '/upload_cif',
         type: 'POST',
         // data: {'name':file.name},
         data: new FormData($('form')[0]),
         cache: false,
         contentType: false,
         processData: false,
         success: function(data){
           if (data!='ok'){show_error(data,true)}
          else{show_error(data,false)}
         },
       });
     }
   }
  }
}
// });


function dialog_new_structure(){
  dialog.dialog( "open" );
};

function set_cif(){
  $('#cif_cif').hide()
  $('#cif_pdb').hide()
  $('#cif_file').hide()
  // $(`#cif_${id}`).show()
  if      ($('#radio_cif')[0].checked)  {$('#cif_cif').show()}
  else if ($('#radio_pdb')[0].checked)  {$('#cif_pdb').show()}
  else if ($('#radio_file')[0].checked) {$('#cif_file').show()}
};
set_cif();
// console.log(new FormData($('form')[0]));

function open_link(link){
  console.log(link);
  window.open(link)
};

</script>

<!-- <script src="static/bower_components/jquery/dist/jquery.min.js"></script>
<script src="static/bower_components/jquery-ui/jquery-ui.js"></script> -->
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="static/bower_components/jquery-ui/themes/base/jquery-ui.css">
<!-- <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" /> -->

<!-- <script src="static/js/jsmol.js"></script> -->

</body>
</html>
